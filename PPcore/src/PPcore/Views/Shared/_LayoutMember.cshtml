@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div id="page-wrapper">
    <div class="row">
        <div class="col-lg-12"  style="padding-top:15px;">
            <table><tr><td><h4 class="txt-color-blue">ข้อมูลสมาชิก</h4></td><td class="txt-color-blue" style="padding-top:2px">&nbsp;&nbsp;&nbsp;&nbsp;@ViewBag.Title</td></tr></table>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12">
            <div class="panel panel-blue">
                <div class="panel-body">

                    @if (ViewBag.panelBarMenu == "Create")
                    {
                        <ul class="nav nav-tabs">
                            <li>
                                <a id="members" href="@Url.Action("Edit", "members", new {id=ViewBag.memberId})" data-toggle="tab">ข้อมูลตามบัตรประชาชน<br />และข้อมูลการติดต่อกลับ</a>
                            </li>
                        </ul>
                    }
                    else if (ViewBag.panelBarMenu == "Details")
                    {
                        <ul class="nav nav-tabs">
                            <li>
                                <a id="members" onclick="location.href='@Url.Action("Details", "members", new {id=ViewBag.memberId})'">ข้อมูลตามบัตรประชาชน<br />และข้อมูลการติดต่อกลับ</a>
                            </li>
                            <li>
                                <a id="mem_train_record" onclick="location.href='@Url.Action("Index", "mem_train_record", new {memberId=ViewBag.memberId, v = 1})'" data-toggle="tab" style="width:140px;">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ประวัติการฝึกอบรม</div></a>
                            </li>
                            <li>
                                <a id="mem_site_visit" onclick="location.href='@Url.Action("Index", "mem_site_visit", new {memberId=ViewBag.memberId, v = 1})'" data-toggle="tab" style="width:120px;">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ประวัติการดูงาน</div></a>
                            </li>
                            <li>
                                <a id="mem_social" onclick="location.href='@Url.Action("Index", "mem_social", new {memberId=ViewBag.memberId, v = 1})'" data-toggle="tab">ประสบการณ์ในการ<br />ช่วยเหลือสังคม</a>
                            </li>
                            <li>
                                <a id="mem_reward" onclick="location.href='@Url.Action("Index", "mem_reward", new {memberId=ViewBag.memberId, v = 1})'" data-toggle="tab">รางวัลเชิดชูเกียรติ<br />ที่เคยได้รับ</a>
                            </li>
                            <li>
                                <a id="mem_education" onclick="location.href='@Url.Action("Index", "mem_education", new {memberId=ViewBag.memberId, v = 1})'" style="width:120px;">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ข้อมูลการศึกษา</div></a>
                            </li>
                            <li>
                                <a id="mem_health" onclick="location.href='@Url.Action("Index", "mem_health", new {memberId=ViewBag.memberId, v = 1})'" style="width:110px;">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ข้อมูลสุขภาพ</div></a>
                            </li>
                            <li>
                                <a id="mem_worklist" onclick="location.href='@Url.Action("Index", "mem_worklist", new {memberId=ViewBag.memberId, v = 1})'">ข้อมูลสถานที่ทำงาน<br />และประวัติการทำงาน</a>
                            </li>
                            <li>
                                <a id="mem_product" onclick="mem_productIndex('@ViewBag.memberId');" style="width:140px;" data-toggle="tab">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ผลิตผลในครัวเรือน</div></a>
                            </li>
                        </ul>
                    }
                    else
                    {
                        <ul class="nav nav-tabs">
                            <li>
                                <a id="members" onclick="location.href='@Url.Action("Edit", "members", new {id=ViewBag.memberId})'">ข้อมูลตามบัตรประชาชน<br />และข้อมูลการติดต่อกลับ</a>
                            </li>
                            <li>
                                <a id="mem_train_record" onclick="location.href='@Url.Action("Index", "mem_train_record", new {memberId=ViewBag.memberId})'" data-toggle="tab" style="width:140px;">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ประวัติการฝึกอบรม</div></a>
                            </li>
                            <li>
                                <a id="mem_site_visit" onclick="location.href='@Url.Action("Index", "mem_site_visit", new {memberId=ViewBag.memberId})'" data-toggle="tab" style="width:120px;">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ประวัติการดูงาน</div></a>
                            </li>
                            <li>
                                <a id="mem_social" onclick="location.href='@Url.Action("Index", "mem_social", new {memberId=ViewBag.memberId})'" data-toggle="tab">ประสบการณ์ในการ<br />ช่วยเหลือสังคม</a>
                            </li>
                            <li>
                                <a id="mem_reward" onclick="location.href='@Url.Action("Index", "mem_reward", new {memberId=ViewBag.memberId})'" data-toggle="tab">รางวัลเชิดชูเกียรติ<br />ที่เคยได้รับ</a>
                            </li>
                            <li>
                                <a id="mem_education" onclick="location.href='@Url.Action("Index", "mem_education", new {memberId=ViewBag.memberId})'" style="width:120px;">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ข้อมูลการศึกษา</div></a>
                            </li>
                            <li>
                                <a id="mem_health" onclick="location.href='@Url.Action("Index", "mem_health", new {memberId=ViewBag.memberId})'" style="width:110px;">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ข้อมูลสุขภาพ</div></a>
                            </li>
                            <li>
                                <a id="mem_worklist" onclick="location.href='@Url.Action("Index", "mem_worklist", new {memberId=ViewBag.memberId})'" >ข้อมูลสถานที่ทำงาน<br />และประวัติการทำงาน</a>
                            </li>
                            <li>
                                <a id="mem_product" onclick="mem_productIndex('@ViewBag.memberId');" style="width:140px;" data-toggle="tab">&nbsp;<br /><br /><div style="position:absolute;top:20px;">ผลิตผลในครัวเรือน</div></a>
                            </li>
                        </ul>
                    }
                    <div style="background-color:#093D6A;height:8px;"></div>
                    <br />
                    <div id="renderBody">
                        @RenderBody()
                    </div>
</div>
</div>
        </div>
    </div>
</div>

                
@section scripts
{
    @RenderSection("scripts", required: false)

    <script>
        $(document).ready(function () {
            var con = '@ViewContext.RouteData.Values["controller"]';
            var act = '@ViewContext.RouteData.Values["action"]';
            $('#' + con).parent().addClass('active');

            if (con == "members") {
                $.datepicker.regional['th'] = {
                    dateFormat: 'dd-mm-yy', changeMonth: true, changeYear: true, constrainInput: true,
                    yearRange: "-100:+0", yearOffSet: 543, beforeShow: dateDefault
                };
                $.datepicker.setDefaults($.datepicker.regional['th']);
                $("#birthdate").datepicker($.datepicker.regional["th"]);

                setEventDropdownProvince();

                if (act == "Create") {
                    $('#province_code').trigger("change"); $('#district_code').trigger("change"); $('#subdistrict_code').trigger("change");
                } else if (act == "Edit") {
                    setTabColor();
                    setProvinceData();
                } else if (act == "Details") {
                    setTabColor();
                    setProvinceData();
                    setTimeout(function () {
                        $('input').each(function () {
                            if (!($(this).attr('disabled'))) {
                                $(this).attr({ 'disabled': 'disabled' });
                            }
                        });
                        $('select').each(function () {
                            if (!($(this).attr('disabled'))) {
                                $(this).attr({ 'disabled': 'disabled' });
                            }
                        });
                        if (!($('#birthdateButton').attr('disabled'))) {
                            $('#birthdateButton').attr({ 'disabled': 'disabled' });
                        }
                        $('#btnGoEdit').show(); $('#btnSave').hide();
                    }, 1000);
                }
            } else {
                setTabColor();
            }

            $('#mem_photo').hide(); $('#cid_card_pic').hide();



            if (act != "Create") {
                if ("@ViewBag.memPhoto") {
                    $('#waitMemPhoto').hide(); $('#emptyMemPhoto').hide();
                    $('#picMemPhotoSrc').attr('src', '/@ViewBag.images_member/@ViewBag.memPhoto'); $('#picMemPhoto').show();
                }
                if ("@ViewBag.cidCardPhoto") {
                    $('#waitCidCardPhoto').hide(); $('#emptyCidCardPhoto').hide();
                    $('#picCidCardPhotoSrc').attr('src', '/@ViewBag.images_member/@ViewBag.cidCardPhoto'); $('#picCidCardPhoto').show();
                }
                $('#btnPrint').show();
            }




        });

        $('#birthdateButton').click(function () {
            $('#birthdate').datepicker("show");
        });

        function dateDefault() {
            if ($("#birthdate").val() == "") { $("#birthdate").datepicker("setDate", new Date()); }
        }
        function setAge() {
            var dob = $('#birthdate').val().split('-');
            var d = new Date();
            var age = d.getFullYear() - dob[2] + 543;
            $('#current_age').val(age)
        }

        function setTextAAddress() {
            var texta = '';
            if ($('#place_name').val() != '') { texta += $('#place_name').val(); }
            if ($('#building').val() != '') { texta += ' อาคาร ' + $('#building').val(); }
            if ($('#floor').val() != '') { texta += ' ชั้น ' + $('#floor').val(); }
            if ($('#room').val() != '') { texta += ' ห้อง ' + $('#room').val(); }
            if ($('#village').val() != '') { texta += ' หมู่บ้าน ' + $('#village').val(); }
            $('#texta_address').val(texta);
        }
        function setTextBAddress() {
            var textb = '';
            if ($('#h_no').val() != '') { textb += 'บ้านเลขที่ ' + $('#h_no').val(); }
            if ($('#lot_no').val() != '') { textb += ' หมู่ที่ ' + $('#lot_no').val(); }
            if ($('#street').val() != '') { textb += ' ถนน ' + $('#street').val(); }
            if ($('#lane').val() != '') { textb += ' ตรอก/ซอย ' + $('#lane').val(); }
            $('#textb_address').val(textb);
        }
        function setTextCAddress() {
            var textc = '';

            if ($("#province_code option:selected").text() != '') { textc = ' จังหวัด ' + $("#province_code option:selected").text(); }
            if ($("#district_code option:selected").text() != '') { textc = ' อำเภอ ' + $("#district_code option:selected").text() + textc; }
            if ($("#subdistrict_code option:selected").text() != '') { textc = 'ตำบล/แขวง ' + $("#subdistrict_code option:selected").text() + textc; }

            //if ($("#subdistrict_code option:selected").text() != '') { textc += 'ตำบล/แขวง ' + $("#subdistrict_code option:selected").text(); }
            //if ($("#district_code option:selected").text() != '') { textc += ' อำเภอ ' + $("#district_code option:selected").text(); }
            //if ($("#province_code option:selected").text() != '') { textc += ' จังหวัด ' + $("#province_code option:selected").text(); }
            if ($('#zip_code').val() != '') { textc += ' รหัสไปรษณีย์ ' + $('#zip_code').val(); }
            //if ($('#zone').val() != '') { textc += ' ภาค ' + $('#zone').val(); }
            //if ($('#country_code').val() != '') { textc += ' ประเทศ ' + $('#country_code').val(); }
            $('#textc_address').val(textc);
        }

        function uploadMemPhoto() {
            if ($('#fileMemPhoto')[0].files[0]) {
                $('#waitMemPhoto').show();
                var formData = new FormData();
                formData.append("fileMemPhoto", $('#fileMemPhoto')[0].files[0]);
                $.ajax({
                    type: 'post', url: '@Url.Action("uploadMemPhoto", "members")',
                    data: formData, processData: false, contentType: false,
                }).done(function (resp) {
                    var result = resp.result; var fileName = resp.fileName;
                    $('#mem_photo').val(resp.fileName);
                    $('#waitMemPhoto').hide(); $('#emptyMemPhoto').hide();
                    $('#picMemPhotoSrc').attr('src', '/@ViewBag.images_upload/' + resp.fileName); $('#picMemPhoto').show();
                });
            }
        }

        function uploadCidCardPhoto() {
            if ($('#fileCidCardPhoto')[0].files[0]) {
                $('#waitCidCardPhoto').show();
                var formData = new FormData();
                formData.append("fileCidCardPhoto", $('#fileCidCardPhoto')[0].files[0]);
                $.ajax({
                    type: 'post', url: '@Url.Action("uploadCidCardPhoto", "members")',
                    data: formData, processData: false, contentType: false,
                }).done(function (resp) {
                    var result = resp.result; var fileName = resp.fileName;
                    $('#cid_card_pic').val(resp.fileName);
                    $('#waitCidCardPhoto').hide(); $('#emptyCidCardPhoto').hide();
                    $('#picCidCardPhotoSrc').attr('src', '/@ViewBag.images_upload/' + resp.fileName); $('#picCidCardPhoto').show();
                });
            }
        }

        function setEventDropdownProvince() {
            $('#province_code').unbind("change").bind("change", function (e) {
                $.ajax({
                    type: 'get', url: '@Url.Action("SelectBy", "ini_district")' + '?provinceCode=' + $('#province_code').val(),
                }).done(function (resp) {
                    if (resp == "") {
                        $('#district_code').empty();
                        $("#district_code").prop("disabled", true);
                        $('#subdistrict_code').empty();
                        $('#subdistrict_code').prop("disabled", true);
                        $('#zip_code').val('');
                        setTextCAddress();
                    } else {
                        $("#district_code").prop("disabled", false);
                        $('#district_code').empty();
                        $('#district_code').append(resp);
                        $('#district_code').trigger("change");
                        setTextCAddress();
                    }
                });

            });
            $('#district_code').unbind("change").bind("change", function (e) {
                $.ajax({
                    type: 'get', url: '@Url.Action("SelectBy", "ini_subdistrict")' + '?districtCode=' + $('#district_code').val(),
                }).done(function (resp) {
                    if (resp == "") {
                        $('#subdistrict_code').empty();
                        $('#subdistrict_code').prop("disabled", true);
                        $('#zip_code').val('');
                        setTextCAddress();
                    } else {
                        $("#subdistrict_code").prop("disabled", false);
                        $('#subdistrict_code').empty();
                        $('#subdistrict_code').append(resp);
                        $('#subdistrict_code').trigger("change");
                        setTextCAddress();
                    }
                });

            });
            $('#subdistrict_code').unbind("change").bind("change", function (e) {
                $.ajax({
                    type: 'get', url: '@Url.Action("SelectBy", "ini_list_zip")' + '?subdistrictCode=' + $('#subdistrict_code').val(),
                }).done(function (resp) {
                    if (resp == "") {
                        $('#zip_code').val(''); setTextCAddress();
                    } else {
                        $('#zip_code').val(resp); setTextCAddress();
                    }
                });

            });
        }
        function setProvinceData() {
            $('#province_code').trigger("change");
            setTimeout(function () {
                $('#district_code').val('@ViewBag.districtCode');
                $('#district_code').trigger("change");
                setTimeout(function () {
                    $('#subdistrict_code').val('@ViewBag.subdistrictCode');
                    setTimeout(function () {
                        $('#zip_code').val('@ViewBag.zipCode');
                    }, 300);
                }, 300);
            }, 300);
        }

        function mem_productIndex(memberId) {
            $.ajax({
                type: 'get', url: '@Url.Action("Index", "mem_product")'+'?memberId=' + memberId,
            }).done(function (resp) {
                $('#renderBody').html(resp);
                setDataTablesSimple();
            });
        }
        function mem_productProductDetailsAsTableList(memberId) {
            $.ajax({
                type: 'get', url: '@Url.Action("DetailsAsTableList", "products")' + '?memberId=' + memberId,
            }).done(function (resp) {
                $('#mem_productProductDetailsAsTableListModalRenderBody').html(resp);
                var table = setTableProductDetailsAsTableList($('#dataTablesProductDetailsAsTableList'));
                $('#product_type').on('change', function () {
                    var sPattern = $('#searchPattern').val().trim();
                    $.ajax({
                        type: 'get', url: '@Url.Action("DetailsAsJsonList", "products")' + '?product_type_code=' + $('#product_type').val() + '&product_group_code=' + $('#product_group').val() + '&pattern='+sPattern,
                    }).done(function (resp) {
                        if (resp != "") {
                            resp = JSON.parse(resp);
                            if (!jQuery.isEmptyObject(resp)) {
                                table.clear().draw();
                                for (var i in resp) {
                                    table.row.add([resp[i].rec_no, resp[i].product_code, resp[i].product_desc, '<div id="btnS' + resp[i].id + '"><div class="btn btn-xs btn-default btn-panel-yellow" onclick="mem_productCreate(\'' + resp[i].id + '\')">&nbsp;<i class="fa fa-plus-circle" aria-hidden="true" style="color:white;"></i>&nbsp;&nbsp;เลือก&nbsp;&nbsp;</div></div>']);
                                }
                                table.draw();
                            } else {
                                table.clear().draw();
                            }
                        } else {
                            table.clear().draw();
                        }
                    });
                });
                $('#product_group').on('change', function () {
                    $.ajax({
                        type: 'get', url: '@Url.Action("SelectBy", "product_type")' + '?product_group_code=' + $('#product_group').val(),
                    }).done(function (resp) {
                        if (resp != "") {
                            $('#product_type').empty();
                            $('#product_type').append(resp);
                            $('#product_type').trigger("change");
                        } else {
                            $('#product_type').empty();
                        }
                    });
                });
                $('#product_group').trigger("change");
                $('#mem_productProductDetailsAsTableListModal').modal({ backdrop: 'static', keyboard: false });
            });

        }
        function mem_productProductCreateGet(memberId) {
            $.ajax({
                type: 'get', url: '@Url.Action("Create", "products")' + '?memberId=' + memberId,
            }).done(function (resp) {
                $('#mem_productProductCreateModalRenderBody').html(resp);
                $('#mem_productProductCreateModalLabel').text('เพิ่มผลิตผลที่ต้องการ');
                $('#product_group_code').text($('#product_group').val());
                $('#product_type_code').text($('#product_type').val());
                $('#product_code').val(''); $('#product_desc').val('');
            });
            $('#mem_productProductCreateModal').modal({ backdrop: 'static', keyboard: false });
        }
        function mem_productProductCreatePost() {
            var productCode = $('#product_code').val().trim();
            var productDesc = $('#product_desc').val().trim();
            if (productCode == "") { $('#product_code_msg').text('กรุณากรอกข้อมูล'); }
            if (productDesc == "") { $('#product_desc_msg').text('กรุณากรอกข้อมูล'); }
            if ((productCode != '') && (productDesc != '')) {
                $.ajax({
                    type: 'post', url: '@Url.Action("Create", "products")' + '?product_code=' + productCode + '&product_group_code=' + $('#product_group_code').text() + '&product_type_code=' + $('#product_type_code').text() + '&product_desc=' + productDesc,
                }).done(function (resp) {
                    console.log(resp);
                    if (resp != "") {
                        if (resp.result == "success") {
                            var table = $('#dataTablesProductDetailsAsTableList').DataTable();
                            table.row.add([resp.rec_no, resp.product_code, resp.product_desc, '<div id="btnS' + resp.id + '"><div class="btn btn-xs btn-default btn-panel-yellow" onclick="mem_productCreate(' + resp.id + ')">&nbsp;<i class="fa fa-plus-circle" aria-hidden="true" style="color:white;"></i>&nbsp;&nbsp;เลือก&nbsp;&nbsp;</div></div>']);
                            table.draw();
                            $('#mem_productProductCreateModal').modal('hide');
                        } else if (resp.result == "fail") {
                            $('#product_code_msg').text('รหัสผลิตผลซ้ำ');
                        }

                    }

                });

            }
        }
        function mem_productCreate(productId) {
            var id = "btnS" + productId; console.log(id);
            //var oldV = $("div[id='" + id + "']").text();
            var oldV = $('#' + id).html();
            $('#' + id).html('<i class="fa fa-spin fa-refresh" aria-hidden="true" style="color:#093D6A;"></i>');

            $.ajax({
                type: 'get', url: '@Url.Action("Create", "mem_product")' + '?memberId=@ViewBag.memberId&productId=' + productId,
            }).done(function (resp) {
                if (resp.result == "success") {
                    var table = $('#dataTablesSimple').DataTable();
                    table.row.add([resp.rec_no, resp.mem_product_id, resp.product_group_desc, resp.product_type_desc, resp.product_desc]);
                    table.draw();
                } else {

                }
                setTimeout(function () { $('#' + id).html(oldV); }, 1000);
            });
        }
        function mem_productProductSearch() {
            console.log('test');
            $('#product_type').trigger("change");
        }
        function setTabColor() {
            $.ajax({
                type: 'get', url: '@Url.Action("ListTabNoData", "members", new { memberId = @ViewBag.memberId })',
            }).done(function (resp) {
                resp = JSON.parse(resp);
                for (i = 0; i < resp.length; i++) {
                    $('#' + resp[i].name).addClass('tabNoData');
                }
            });
        }
        function memberPrint() {
                var url = '@Url.Action("DetailsPdf", "members", new { id = "__id__" })';
                //window.location.href = url.replace('__id__', data[1]);
                //var win = window.open(url.replace('__id__', '@ViewBag.memberId'), '_blank');
                var win = window.open(url.replace('__id__', '@ViewBag.memberId'));
                win.focus();

                //window.open(url.replace('__id__', '@ViewBag.memberId'), "_blank", "toolbar=yes,scrollbars=yes,resizable=yes,top=500,left=500,width=400,height=400");




        }
    </script>
}

